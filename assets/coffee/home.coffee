#==========================================
# Component
#==========================================
Vue.component 'download-button',
  template: """
    <button class="button full-width" type="button" v-on:click="handle_html2canvas" v-bind:disabled="processing">下載圖片</button>
  """
  data: ->
    {
      processing: false
    }
  methods:
    handle_html2canvas: ->
      @processing = true
      NProgress.start()
      self = @
      setTimeout(( ->
        html2canvas(document.querySelector('#output-container'), { scale: 1, logging: false }).then (canvas) ->
          base64 = canvas.toDataURL 'image/png'
          if isMobile()
            self.upload_imgur base64, (result) ->
              if result.data.link
                NProgress.done()
                image_url = 'https://i.imgur.com/' + result.data.id + '.png'
                swal
                  text: '請在圖片上長按以下載圖片'
                  imageUrl: image_url
                  animation: false
                  confirmButtonText: '關閉'
                  confirmButtonClass: 'button full-width'
                  buttonsStyling: false
              else
                NProgress.done()
                alert '糟糕！出錯了！請稍後再試！'
            , (error) ->
              alert '糟糕！出錯了！請稍後再試！'
          else
            NProgress.done()
            forceDownload base64, 'image.png'
          self.processing = false
      ).bind(@), 1000)

    upload_imgur: (base64, callback, error_callback) ->
      self = @
      $.ajax
        url: 'https://api.imgur.com/3/image'
        type: 'post'
        headers: Authorization: 'Client-ID 36f2c6c4618678a'
        data:
          image: base64.split(",")[1]
          type: 'base64'
          description: 'Image generate by: https://free-beijing-tour-connection.unlink.men'
        dataType: 'json'
        success: (result) ->
          if result.success
            callback result
          else
            alert '糟糕！出錯了！請稍後再試！'
        error: (error) ->
          error_callback error


#==========================================
# App
#==========================================
app = new Vue(
  delimiters: ['{!', '!}']
  el: '#app'
  data:
    track: [
      {"x":289,"y":305},{"x":290,"y":305},{"x":290,"y":305},{"x":291,"y":305},{"x":291,"y":305},
      {"x":292,"y":305},{"x":292,"y":304},{"x":292,"y":304},{"x":293,"y":304},{"x":293,"y":304},
      {"x":294,"y":304},{"x":294,"y":304},{"x":295,"y":303},{"x":295,"y":303},{"x":296,"y":303},
      {"x":296,"y":303},{"x":296,"y":303},{"x":297,"y":302},{"x":297,"y":302},{"x":297,"y":302},
      {"x":298,"y":302},{"x":298,"y":301},{"x":299,"y":301},{"x":300,"y":301},{"x":300,"y":300},
      {"x":301,"y":300},{"x":302,"y":299},{"x":302,"y":299},{"x":302,"y":299},{"x":303,"y":299},
      {"x":303,"y":298},{"x":303,"y":298},{"x":304,"y":298},{"x":304,"y":297},{"x":304,"y":297},
      {"x":305,"y":297},{"x":305,"y":297},{"x":305,"y":297},{"x":305,"y":297},{"x":310,"y":315},
      {"x":312,"y":315},{"x":314,"y":314},{"x":315,"y":314},{"x":316,"y":314},{"x":318,"y":314},
      {"x":318,"y":314},{"x":319,"y":313},{"x":319,"y":313},{"x":320,"y":313},{"x":320,"y":313},
      {"x":320,"y":313},{"x":320,"y":313},{"x":320,"y":313},{"x":320,"y":313},{"x":320,"y":313},
      {"x":320,"y":313},{"x":321,"y":313},{"x":321,"y":312},{"x":322,"y":312},{"x":322,"y":312},
      {"x":322,"y":312},{"x":322,"y":312},{"x":323,"y":311},{"x":323,"y":311},{"x":323,"y":311},
      {"x":324,"y":311},{"x":324,"y":311},{"x":324,"y":311},{"x":324,"y":310},{"x":324,"y":310},
      {"x":325,"y":310},{"x":325,"y":310},{"x":325,"y":310},{"x":325,"y":310},{"x":325,"y":310},
      {"x":325,"y":310},{"x":325,"y":309},{"x":326,"y":309},{"x":326,"y":309},{"x":326,"y":309},
      {"x":326,"y":309},{"x":326,"y":309},{"x":326,"y":308},{"x":311,"y":307},{"x":312,"y":308},
      {"x":313,"y":308},{"x":313,"y":308},{"x":314,"y":308},{"x":314,"y":308},{"x":314,"y":308},
      {"x":315,"y":308},{"x":315,"y":308},{"x":315,"y":308},{"x":315,"y":308},{"x":316,"y":308},
      {"x":316,"y":308},{"x":316,"y":308},{"x":317,"y":308},{"x":317,"y":308},{"x":317,"y":308},
      {"x":317,"y":308},{"x":317,"y":308},{"x":318,"y":308},{"x":318,"y":308},{"x":318,"y":308},
      {"x":318,"y":308},{"x":318,"y":308},{"x":319,"y":308},{"x":319,"y":308},{"x":319,"y":308},
      {"x":319,"y":308},{"x":320,"y":308},{"x":320,"y":308},{"x":320,"y":308},{"x":320,"y":308},
      {"x":320,"y":308},{"x":321,"y":308},{"x":321,"y":308},{"x":321,"y":308},{"x":322,"y":307},
      {"x":322,"y":307},{"x":322,"y":307},{"x":323,"y":307},{"x":323,"y":307},{"x":323,"y":307},
      {"x":324,"y":307},{"x":324,"y":307},{"x":324,"y":307},{"x":325,"y":307},{"x":325,"y":307},
      {"x":325,"y":307},{"x":326,"y":306},{"x":326,"y":306},{"x":326,"y":306},{"x":327,"y":306},
      {"x":327,"y":306},{"x":327,"y":306},{"x":328,"y":305},{"x":329,"y":305},{"x":330,"y":304},
      {"x":331,"y":303},{"x":331,"y":302},{"x":332,"y":301},{"x":332,"y":301},{"x":332,"y":300},
      {"x":333,"y":300},{"x":333,"y":299},{"x":333,"y":299},{"x":333,"y":299},{"x":333,"y":298},
      {"x":333,"y":298},{"x":333,"y":298},{"x":333,"y":298},{"x":333,"y":298},{"x":334,"y":297},
      {"x":334,"y":297},{"x":334,"y":297},{"x":334,"y":296},{"x":334,"y":296},{"x":334,"y":295},
      {"x":334,"y":295},{"x":334,"y":294},{"x":334,"y":294},{"x":335,"y":292},{"x":335,"y":290},
      {"x":336,"y":289},{"x":336,"y":288},{"x":336,"y":287},{"x":336,"y":286},{"x":337,"y":285},
      {"x":337,"y":284},{"x":337,"y":283},{"x":337,"y":282},{"x":337,"y":281},{"x":338,"y":280},
      {"x":338,"y":279},{"x":338,"y":278},{"x":338,"y":278},{"x":338,"y":277},{"x":339,"y":276},
      {"x":339,"y":275},{"x":339,"y":274},{"x":339,"y":273},{"x":339,"y":273},{"x":340,"y":271},
      {"x":340,"y":270},{"x":340,"y":269},{"x":340,"y":268},{"x":340,"y":267},{"x":340,"y":266},
      {"x":340,"y":265},{"x":340,"y":264},{"x":341,"y":263},{"x":341,"y":262},{"x":341,"y":261},
      {"x":341,"y":260},{"x":341,"y":260},{"x":341,"y":259},{"x":341,"y":258},{"x":341,"y":257},
      {"x":341,"y":256},{"x":341,"y":256},{"x":341,"y":255},{"x":341,"y":254},{"x":341,"y":253},
      {"x":341,"y":252},{"x":341,"y":252},{"x":341,"y":251},{"x":341,"y":250},{"x":341,"y":250},
      {"x":341,"y":249},{"x":341,"y":248},{"x":341,"y":248},{"x":341,"y":247},{"x":341,"y":246},
      {"x":341,"y":246},{"x":341,"y":245},{"x":341,"y":244},{"x":341,"y":244},{"x":341,"y":243},
      {"x":341,"y":242},{"x":341,"y":242},{"x":341,"y":241},{"x":341,"y":240},{"x":341,"y":239},
      {"x":341,"y":239},{"x":341,"y":238},{"x":341,"y":237},{"x":341,"y":236},{"x":341,"y":236},
      {"x":341,"y":235},{"x":341,"y":235},{"x":341,"y":234},{"x":341,"y":234},{"x":341,"y":233},
      {"x":340,"y":233},{"x":340,"y":232},{"x":340,"y":231},{"x":340,"y":230},{"x":340,"y":229},
      {"x":340,"y":228},{"x":340,"y":228},{"x":340,"y":227},{"x":340,"y":225},{"x":340,"y":224},
      {"x":339,"y":223},{"x":339,"y":221},{"x":339,"y":220},{"x":339,"y":219},{"x":339,"y":217},
      {"x":339,"y":215},{"x":338,"y":214},{"x":338,"y":212},{"x":338,"y":210},{"x":337,"y":208},
      {"x":337,"y":207},{"x":336,"y":206},{"x":336,"y":205},{"x":336,"y":204},{"x":336,"y":204},
      {"x":336,"y":203},{"x":336,"y":203},{"x":335,"y":203},{"x":335,"y":203},{"x":335,"y":202},
      {"x":335,"y":202},{"x":335,"y":202},{"x":335,"y":202},{"x":334,"y":201},{"x":334,"y":201},
      {"x":333,"y":200},{"x":333,"y":199},{"x":332,"y":199},{"x":331,"y":198},{"x":331,"y":198},
      {"x":330,"y":197},{"x":329,"y":197},{"x":328,"y":196},{"x":327,"y":196},{"x":327,"y":196},
      {"x":326,"y":196},{"x":326,"y":195},{"x":326,"y":195},{"x":325,"y":195},{"x":325,"y":195},
      {"x":324,"y":195},{"x":324,"y":194},{"x":323,"y":194},{"x":323,"y":194},{"x":322,"y":194},
      {"x":322,"y":193},{"x":321,"y":193},{"x":321,"y":193},{"x":320,"y":193},{"x":319,"y":193},
      {"x":318,"y":193},{"x":317,"y":192},{"x":316,"y":192},{"x":316,"y":192},{"x":315,"y":192},
      {"x":315,"y":192},{"x":314,"y":192},{"x":313,"y":192},{"x":313,"y":192},{"x":312,"y":192},
      {"x":310,"y":192},{"x":309,"y":192},{"x":308,"y":192},{"x":307,"y":192},{"x":306,"y":192},
      {"x":305,"y":192},{"x":304,"y":192},{"x":303,"y":192},{"x":302,"y":192},{"x":300,"y":192},
      {"x":298,"y":192},{"x":297,"y":192},{"x":296,"y":192},{"x":295,"y":192},{"x":294,"y":192},
      {"x":292,"y":192},{"x":291,"y":192},{"x":290,"y":192},{"x":289,"y":192},{"x":287,"y":192},
      {"x":286,"y":193},{"x":285,"y":193},{"x":283,"y":193},{"x":282,"y":193},{"x":281,"y":193},
      {"x":279,"y":193},{"x":278,"y":193},{"x":277,"y":194},{"x":276,"y":194},{"x":275,"y":194},
      {"x":274,"y":194},{"x":273,"y":194},{"x":272,"y":194},{"x":271,"y":194},{"x":270,"y":195},
      {"x":268,"y":195},{"x":267,"y":195},{"x":266,"y":195},{"x":266,"y":195},{"x":265,"y":195},
      {"x":264,"y":196},{"x":263,"y":196},{"x":262,"y":196},{"x":261,"y":196},{"x":260,"y":196},
      {"x":259,"y":197},{"x":258,"y":197},{"x":257,"y":197},{"x":256,"y":197},{"x":255,"y":197},
      {"x":254,"y":197},{"x":253,"y":198},{"x":252,"y":198},{"x":250,"y":198},{"x":249,"y":199},
      {"x":248,"y":199},{"x":246,"y":200},{"x":244,"y":200},{"x":243,"y":201},{"x":241,"y":201},
      {"x":240,"y":202},{"x":239,"y":202},{"x":238,"y":203},{"x":236,"y":204},{"x":234,"y":205},
      {"x":232,"y":206},{"x":231,"y":207},{"x":230,"y":207},{"x":228,"y":208},{"x":227,"y":208},
      {"x":227,"y":209},{"x":226,"y":209},{"x":226,"y":210},{"x":225,"y":210},{"x":225,"y":211},
      {"x":224,"y":212},{"x":223,"y":213},{"x":223,"y":214},{"x":222,"y":216},{"x":221,"y":217},
      {"x":221,"y":219},{"x":221,"y":220},{"x":220,"y":222},{"x":220,"y":223},{"x":219,"y":224},
      {"x":219,"y":226},{"x":219,"y":227},{"x":218,"y":229},{"x":218,"y":230},{"x":217,"y":231},
      {"x":217,"y":233},{"x":217,"y":234},{"x":217,"y":234},{"x":217,"y":235},{"x":217,"y":236},
      {"x":216,"y":236},{"x":216,"y":237},{"x":216,"y":239},{"x":216,"y":240},{"x":216,"y":241},
      {"x":216,"y":242},{"x":216,"y":242},{"x":215,"y":243},{"x":215,"y":244},{"x":215,"y":245},
      {"x":215,"y":246},{"x":215,"y":246},{"x":215,"y":247},{"x":215,"y":248},{"x":215,"y":249},
      {"x":215,"y":249},{"x":215,"y":250},{"x":215,"y":250},{"x":214,"y":251},{"x":214,"y":252},
      {"x":214,"y":252},{"x":214,"y":253},{"x":214,"y":254},{"x":214,"y":255},{"x":214,"y":256},
      {"x":214,"y":257},{"x":214,"y":258},{"x":213,"y":259},{"x":213,"y":260},{"x":213,"y":261},
      {"x":213,"y":263},{"x":213,"y":264},{"x":212,"y":266},{"x":212,"y":268},{"x":211,"y":270},
      {"x":211,"y":272},{"x":211,"y":273},{"x":210,"y":275},{"x":210,"y":277},{"x":210,"y":278},
      {"x":209,"y":279},{"x":209,"y":279},{"x":209,"y":280},{"x":209,"y":281},{"x":209,"y":281},
      {"x":209,"y":282},{"x":209,"y":282},{"x":209,"y":283},{"x":208,"y":283},{"x":208,"y":284},
      {"x":208,"y":284},{"x":208,"y":285},{"x":208,"y":286},{"x":208,"y":286},{"x":208,"y":287},
      {"x":208,"y":288},{"x":208,"y":289},{"x":208,"y":289},{"x":208,"y":290},{"x":208,"y":290},
      {"x":207,"y":291},{"x":207,"y":291},{"x":207,"y":292},{"x":207,"y":292},{"x":207,"y":293},
      {"x":207,"y":294},{"x":207,"y":295},{"x":207,"y":296},{"x":207,"y":297},{"x":207,"y":298},
      {"x":207,"y":299},{"x":207,"y":300},{"x":207,"y":301},{"x":208,"y":302},{"x":208,"y":303},
      {"x":208,"y":304},{"x":208,"y":305},{"x":208,"y":306},{"x":208,"y":307},{"x":208,"y":308},
      {"x":208,"y":308},{"x":208,"y":309},{"x":208,"y":309},{"x":208,"y":310},{"x":208,"y":311},
      {"x":209,"y":312},{"x":209,"y":312},{"x":209,"y":313},{"x":209,"y":313},{"x":209,"y":314},
      {"x":209,"y":315},{"x":210,"y":315},{"x":210,"y":316},{"x":210,"y":317},{"x":210,"y":317},
      {"x":211,"y":318},{"x":211,"y":319},{"x":211,"y":319},{"x":211,"y":320},{"x":212,"y":320},
      {"x":212,"y":321},{"x":212,"y":322},{"x":213,"y":323},{"x":213,"y":324},{"x":213,"y":324},
      {"x":214,"y":325},{"x":214,"y":326},{"x":214,"y":326},{"x":214,"y":327},{"x":214,"y":328},
      {"x":215,"y":328},{"x":215,"y":329},{"x":215,"y":329},{"x":216,"y":330},{"x":216,"y":331},
      {"x":217,"y":332},{"x":217,"y":332},{"x":217,"y":333},{"x":217,"y":333},{"x":218,"y":334},
      {"x":218,"y":334},{"x":218,"y":334},{"x":218,"y":335},{"x":218,"y":335},{"x":219,"y":336},
      {"x":219,"y":336},{"x":219,"y":336},{"x":219,"y":337},{"x":219,"y":337},{"x":220,"y":338},
      {"x":220,"y":338},{"x":220,"y":339},{"x":221,"y":339},{"x":221,"y":339},{"x":221,"y":340},
      {"x":221,"y":340},{"x":222,"y":340},{"x":222,"y":341},{"x":223,"y":341},{"x":223,"y":342},
      {"x":224,"y":343},{"x":224,"y":343},{"x":224,"y":344},{"x":225,"y":344},{"x":225,"y":344},
      {"x":225,"y":345},{"x":225,"y":345},{"x":226,"y":345},{"x":226,"y":346},{"x":226,"y":346},
      {"x":227,"y":346},{"x":227,"y":346},{"x":227,"y":346},{"x":227,"y":347},{"x":227,"y":347},
      {"x":227,"y":347},{"x":228,"y":347},{"x":228,"y":347},{"x":228,"y":347},{"x":229,"y":348},
      {"x":229,"y":348},{"x":229,"y":348},{"x":230,"y":348},{"x":230,"y":348},{"x":230,"y":349},
      {"x":231,"y":349},{"x":231,"y":349},{"x":232,"y":349},{"x":232,"y":350},{"x":232,"y":350},
      {"x":232,"y":350},{"x":232,"y":350},{"x":232,"y":350},{"x":232,"y":350},{"x":233,"y":350},
      {"x":233,"y":350},{"x":233,"y":351},{"x":234,"y":351},{"x":234,"y":351},{"x":234,"y":351},
      {"x":234,"y":352},{"x":235,"y":352},{"x":235,"y":352},{"x":235,"y":352},{"x":236,"y":352},
      {"x":236,"y":353},{"x":236,"y":353},{"x":237,"y":353},{"x":237,"y":353},{"x":237,"y":354},
      {"x":238,"y":354},{"x":239,"y":355},{"x":239,"y":355},{"x":240,"y":355},{"x":240,"y":356},
      {"x":241,"y":356},{"x":241,"y":357},{"x":242,"y":357},{"x":243,"y":358},{"x":243,"y":358},
      {"x":244,"y":358},{"x":244,"y":358},{"x":244,"y":358},{"x":244,"y":358},{"x":244,"y":359},
      {"x":245,"y":359},{"x":245,"y":359},{"x":246,"y":360},{"x":246,"y":360},{"x":247,"y":360},
      {"x":247,"y":360},{"x":247,"y":361},{"x":248,"y":361},{"x":248,"y":361},{"x":248,"y":361},
      {"x":249,"y":361},{"x":249,"y":362},{"x":249,"y":362},{"x":249,"y":362},{"x":250,"y":362},
      {"x":250,"y":362},{"x":250,"y":362},{"x":251,"y":363},{"x":251,"y":363},{"x":252,"y":363},
      {"x":252,"y":364},{"x":253,"y":364},{"x":254,"y":364},{"x":255,"y":365},{"x":256,"y":365},
      {"x":257,"y":366},{"x":258,"y":366},{"x":258,"y":366},{"x":259,"y":366},{"x":259,"y":367},
      {"x":259,"y":367},{"x":260,"y":367},{"x":260,"y":367},{"x":261,"y":367},{"x":261,"y":368},
      {"x":261,"y":368},{"x":261,"y":368},{"x":262,"y":368},{"x":263,"y":369},{"x":263,"y":369},
      {"x":263,"y":369},{"x":263,"y":369},{"x":264,"y":369},{"x":264,"y":370},{"x":265,"y":370},
      {"x":266,"y":370},{"x":266,"y":370},{"x":266,"y":370},{"x":266,"y":370},{"x":266,"y":370},
      {"x":267,"y":371},{"x":267,"y":371},{"x":268,"y":371},{"x":268,"y":371},{"x":268,"y":371},
      {"x":268,"y":371},{"x":269,"y":372},{"x":269,"y":372},{"x":270,"y":372},{"x":270,"y":372},
      {"x":271,"y":372},{"x":271,"y":372},{"x":271,"y":373},{"x":272,"y":373},{"x":272,"y":373},
      {"x":273,"y":373},{"x":273,"y":374},{"x":274,"y":374},{"x":274,"y":374},{"x":274,"y":374},
      {"x":274,"y":374},{"x":275,"y":374},{"x":275,"y":374},{"x":275,"y":375},{"x":275,"y":375},
      {"x":276,"y":375},{"x":276,"y":375},{"x":276,"y":375},{"x":276,"y":375},{"x":276,"y":375},
      {"x":276,"y":375},{"x":276,"y":375},{"x":277,"y":376},{"x":277,"y":376},{"x":277,"y":376},
      {"x":277,"y":376},{"x":277,"y":376},{"x":278,"y":376},{"x":278,"y":376},{"x":278,"y":377},
      {"x":279,"y":377},{"x":280,"y":378},{"x":281,"y":378},{"x":281,"y":378},{"x":281,"y":379},
      {"x":282,"y":379},{"x":282,"y":379},{"x":282,"y":379},{"x":283,"y":379},{"x":283,"y":380},
      {"x":284,"y":380},{"x":284,"y":380},{"x":284,"y":380},{"x":285,"y":380},{"x":285,"y":380},
      {"x":286,"y":381},{"x":287,"y":381},{"x":288,"y":381},{"x":289,"y":382},{"x":290,"y":382},
      {"x":291,"y":382},{"x":292,"y":383},{"x":293,"y":383},{"x":294,"y":383},{"x":294,"y":383},
      {"x":295,"y":383},{"x":295,"y":383},{"x":295,"y":383},{"x":296,"y":383},{"x":296,"y":383},
      {"x":297,"y":383},{"x":297,"y":383},{"x":298,"y":384},{"x":298,"y":384},{"x":299,"y":384},
      {"x":299,"y":384},{"x":300,"y":384},{"x":300,"y":384},{"x":300,"y":384},{"x":300,"y":384},
      {"x":300,"y":384},{"x":301,"y":384},{"x":302,"y":384},{"x":302,"y":384},{"x":303,"y":384},
      {"x":303,"y":384},{"x":303,"y":384},{"x":303,"y":384},{"x":303,"y":384},{"x":304,"y":384},
      {"x":304,"y":384},{"x":304,"y":384},{"x":304,"y":384},{"x":304,"y":384},{"x":305,"y":384},
      {"x":305,"y":385},{"x":305,"y":385},{"x":305,"y":385},{"x":306,"y":385},{"x":306,"y":385},
      {"x":306,"y":385},{"x":306,"y":386},{"x":307,"y":386},{"x":307,"y":386},{"x":307,"y":386},
      {"x":307,"y":386},{"x":308,"y":386},{"x":308,"y":387},{"x":308,"y":387},{"x":308,"y":387},
      {"x":309,"y":387},{"x":309,"y":388},{"x":309,"y":388},{"x":309,"y":388},{"x":309,"y":388},
      {"x":310,"y":388},{"x":310,"y":388},{"x":310,"y":388},{"x":311,"y":389},{"x":311,"y":389},
      {"x":312,"y":389},{"x":313,"y":390},{"x":314,"y":390},{"x":314,"y":390},{"x":315,"y":391},
      {"x":315,"y":391},{"x":315,"y":391},{"x":316,"y":391},{"x":316,"y":391},{"x":316,"y":391},
      {"x":317,"y":391},{"x":317,"y":391},{"x":318,"y":391},{"x":318,"y":391},{"x":319,"y":391},
      {"x":319,"y":392},{"x":320,"y":392},{"x":321,"y":392},{"x":321,"y":392},{"x":322,"y":392},
      {"x":322,"y":392},{"x":322,"y":392},{"x":323,"y":392},{"x":324,"y":392},{"x":324,"y":392},
      {"x":324,"y":392},{"x":324,"y":392},{"x":325,"y":392},{"x":325,"y":392},{"x":325,"y":392},
      {"x":325,"y":392},{"x":326,"y":392},{"x":326,"y":392},{"x":326,"y":393},{"x":326,"y":393},
      {"x":327,"y":393},{"x":327,"y":393},{"x":327,"y":393},{"x":328,"y":393},{"x":328,"y":393},
      {"x":329,"y":393},{"x":329,"y":393},{"x":330,"y":393},{"x":330,"y":393},{"x":330,"y":393},
      {"x":331,"y":393},{"x":331,"y":393},{"x":331,"y":393},{"x":331,"y":393},{"x":332,"y":393},
      {"x":332,"y":393},{"x":332,"y":393},{"x":332,"y":393},{"x":332,"y":393},{"x":332,"y":393},
      {"x":333,"y":393},{"x":333,"y":394},{"x":333,"y":394},{"x":333,"y":394},{"x":333,"y":394},
      {"x":333,"y":394},{"x":333,"y":394},{"x":334,"y":394},{"x":334,"y":394},{"x":334,"y":394},
      {"x":334,"y":394},{"x":334,"y":394},{"x":334,"y":394},{"x":335,"y":394},{"x":336,"y":394},
      {"x":336,"y":395},{"x":336,"y":395},{"x":336,"y":395},{"x":337,"y":395},{"x":337,"y":395},
      {"x":337,"y":395},{"x":338,"y":395},{"x":338,"y":395},{"x":338,"y":395},{"x":339,"y":395},
      {"x":339,"y":395},{"x":340,"y":395},{"x":340,"y":396},{"x":341,"y":396},{"x":341,"y":396},
      {"x":342,"y":396},{"x":342,"y":396}
    ]
    size: 130
    r: 65
    answer_cover_image: '/images/basemap-2.png'
    pattern_image: ''
    question_text1: '手上拿警棍，頭上戴警盔'
    question_text2: '喜揮舞警棍，喜揍暴民'
    question_text3: '安安大家好，我是電線桿，請問你有看過這個人嗎？'
    answer_image: '/images/example.jpg'
    answer_text: '打人警察'
    question_basemap_image: '/images/basemap-1.png'
    answer_basemap_image: '/images/default-answer.png'
    output_image: '/images/default.png'
    countdown: Date.now()
    current_time: Date.now()
    is_mobile: false

  created: ->
    NProgress.start()
    if isMobile()
      @is_mobile = true

  mounted: ->
    images = $('.lazy')
    length = images.length
    counter = 0
    increment_counter = ( ->
      counter++
      if counter == length
        NProgress.done()
        xx 'all images loaded'
    ).bind(@)

    [].forEach.call images, (img) ->
      img.addEventListener 'load', increment_counter, false

  methods:
    generator: ->
      self = @
      html2canvas(document.querySelector('#output-container'), { scale: 1, logging: false }).then (canvas) ->
        base64 = canvas.toDataURL 'image/png'
        self.output_image = base64
        NProgress.done()

    create_basemap: ->
      canvas = document.getElementById('canvas')
      pattern_image = document.getElementById('pattern_image')
      answer_cover_image = document.getElementById('answer_cover_image')
      ctx = canvas.getContext('2d')

      pattern = ctx.createPattern(pattern_image, 'repeat')
      ctx.fillStyle = pattern

      distance_between = (point1, point2) ->
        Math.sqrt (point2.x - (point1.x)) ** 2 + (point2.y - (point1.y)) ** 2

      angle_between = (point1, point2) ->
        Math.atan2 point2.x - (point1.x), point2.y - (point1.y)

      last_point = @track[0]
      for point in @track
        current_point =
          x: point.x
          y: point.y
        dist = distance_between(last_point, current_point)
        angle = angle_between(last_point, current_point)
        i = 0
        while i < dist
          x = last_point.x + Math.sin(angle) * i - 30
          y = last_point.y + Math.cos(angle) * i - 30
          ctx.drawImage pattern_image, x - @r + 10, y - @r + 10, @size, @size
          i += 7
        last_point = current_point

      ctx.drawImage answer_cover_image, 0, 0
      @answer_basemap_image = canvas.toDataURL()
      @generator()

    crop_image: ->
      image = document.getElementById('answer_image')
      image_w = image.naturalWidth
      image_h = image.naturalHeight
      crop_canvas = document.createElement('canvas')
      crop_canvas.width = @size
      crop_canvas.height = @size
      crop_ctx = crop_canvas.getContext('2d')
      crop_ctx.save()
      crop_ctx.beginPath()
      crop_ctx.arc @r, @r, @r, 0, Math.PI * 2, true
      crop_ctx.closePath()
      crop_ctx.clip()
      if image_h > image_w
        w = 130
        h = image_h * (image_w / 130)
        x = 0
        y = 60 - (h / 2)
        crop_ctx.drawImage image, x, y, image_w, image_h
      else if image_w > image_h
        h = 130
        w = image_w * (image_h / 130)
        x = 60 - (w / 2)
        y = 0
        crop_ctx.drawImage image, x, y, w, h
      else
        crop_ctx.drawImage image, 0, 0, @size, @size
      crop_ctx.beginPath()
      crop_ctx.arc 0, 0, @r, 0, Math.PI * 2, true
      crop_ctx.clip()
      crop_ctx.closePath()
      crop_ctx.restore()
      @pattern_image = crop_canvas.toDataURL()

    local_preview: (event, data_key) ->
      xx 'local preview processing'
      @load_preview event.target.files, data_key

    load_preview: (files, data_key) ->
      self = @
      NProgress.start()
      if files and files[0]
        @compress_image files[0], (result) ->
          self.load_preview_image result, data_key
        , (error) ->
          alert '糟糕！出錯了！請稍後再試！'
          NProgress.done()

    load_preview_image: (file, data_key) ->
      reader = new FileReader
      reader.onload = ((e) ->
        eval 'this.' + data_key + ' = e.target.result'
        NProgress.done()
      ).bind @
      reader.readAsDataURL file

    compress_image: (file, callback, error_callback) ->
      new ImageCompressor(file,
        quality: .6
        maxWidth: 200
        maxHeight: 200
        success: (result) ->
          callback result
        error: (error) ->
          error_callback error
      )

    field_clean: (data_key, text) ->
      eval 'if (this.' + data_key + ' === "' + text + '"){ this.' + data_key + ' = ""; }'


  watch:
    question_text1: (value) ->
      @countdown = Date.now()
      setTimeout((->
        @current_time = Date.now()
        if @current_time - @countdown >= 250
          NProgress.start()
          @generator()
      ).bind(@), 250)

    question_text2: (value) ->
      @countdown = Date.now()
      setTimeout((->
        @current_time = Date.now()
        if @current_time - @countdown >= 250
          NProgress.start()
          @generator()
      ).bind(@), 250)

    question_text3: (value) ->
      @countdown = Date.now()
      setTimeout((->
        @current_time = Date.now()
        if @current_time - @countdown >= 250
          NProgress.start()
          @generator()
      ).bind(@), 250)

    answer_text: (value) ->
      @countdown = Date.now()
      setTimeout((->
        @current_time = Date.now()
        if @current_time - @countdown >= 250
          NProgress.start()
          @generator()
      ).bind(@), 250)

    answer_image: (value) ->
      xx 'answer image changed'
      NProgress.start()
      lazy_image = document.createElement('img')
      lazy_image.src = value
      lazy_image.onload = ( ->
        @crop_image()
        setTimeout(( ->
          @create_basemap()
        ).bind(@), 1000)
      ).bind(@)
)
